#!/usr/bin/env bash
# ====================================================================
# SkyScope Sentinel OS - Ultimate AGI Installer
# ====================================================================
# Author: Miss Casey Jay Topojani | 2025 Ultimate Local AGI
# ====================================================================

set -e
export DEBIAN_FRONTEND=noninteractive

# --- Helper Functions ---
info() { echo -e "\e[34m[INFO]\e[0m $1"; }
success() { echo -e "\e[32m[SUCCESS]\e[0m $1"; }
fail() { echo -e "\e[31m[ERROR]\e[0m $1"; exit 1; }

# --- Pre-flight Checks ---
info "Performing pre-flight checks..."
[[ $(id -u) -eq 0 ]] && fail "This script must not be run as root. It will use 'sudo' when necessary."
command -v git >/dev/null 2>&1 || fail "Git is required but not installed. Please install it first."
command -v curl >/dev/null 2>&1 || fail "Curl is required but not installed. Please install it first."

# --- Main Installation ---
info "Updating system and installing dependencies..."
sudo apt-get update -y
sudo apt-get install -y python3 python3-pip python3-venv git curl jq ffmpeg sox vlc imagemagick \
  chromium-driver nodejs npm build-essential unzip wget libnss3 libatk1.0-0 libatk-bridge2.0-0 \
  libcups2 libdrm2 libxkbcommon-x11-0 libgbm1 libasound2

# --- Environment Setup ---
SKYSCOPE_HOME="$HOME/.skyscope_os"
info "Setting up SkyScope OS environment at $SKYSCOPE_HOME..."
mkdir -p "$SKYSCOPE_HOME"/{env,logs,memory,knowledge_stack,agents,mcp,workflows,llm}
python3 -m venv "$SKYSCOPE_HOME/env"
source "$SKYSCOPE_HOME/env/bin/activate"
pip install --upgrade pip wheel

# --- Python Dependencies ---
info "Installing core Python agentic and system dependencies..."
pip install torch torchvision torchaudio numpy pandas requests psutil fastapi uvicorn flask \
  selenium helium sentence-transformers langchain langchain-core langgraph swarms evoagentx \
  smolagents[toolkit] faiss-cpu alive-progress prompt_toolkit google-auth google-auth-oauthlib \
  google-api-python-client pyyaml arxiv docker lief capstone uncompyle6 pyelftools radare2-py \
  triton jinja2 playwright beautifulsoup4 moviepy gtts pyttsx3 whisper ffmpeg-python \
  transformers tqdm gitpython psutil playwright

# Install Playwright browsers
playwright install

# --- n8n Setup ---
info "Installing n8n for local visual workflow orchestration..."
npm install -g n8n pm2
pm2 start "n8n" --name skyscope-n8n
pm2 save
success "n8n is running at http://localhost:5678"

# --- Ollama Setup ---
info "Installing Ollama and pulling minimal models for core intelligence..."
curl -fsSL https://ollama.com/install.sh | sh
ollama pull smollm:135m
ollama pull phi3:mini

# --- Deploying SkyScope OS Modules ---
info "Deploying SkyScope OS Python modules..."
cp orchestrator.py cli.py memory.py tools_chromium.py tool_provisioner.py "$SKYSCOPE_HOME/env/"

# --- CLI Launcher ---
info "Installing the 'skyscope' command-line launcher..."
mkdir -p "$HOME/bin"
cat > "$HOME/bin/skyscope" <<'EOF'
#!/usr/bin/env bash
source "$HOME/.skyscope_os/env/bin/activate"
python3 "$HOME/.skyscope_os/env/cli.py"
EOF
chmod +x "$HOME/bin/skyscope"

if ! echo "$PATH" | grep -q "$HOME/bin"; then
  info "Adding $HOME/bin to your PATH. You may need to restart your shell."
  echo 'export PATH="$HOME/bin:$PATH"' >> "$HOME/.bashrc"
  export PATH="$HOME/bin:$PATH"
fi

# --- Systemd Service for Persistence ---
info "Setting up systemd service for persistent autonomous operation..."
sudo bash -c "cat > /etc/systemd/system/skyscope.service <<EOF
[Unit]
Description=SkyScope Sentinel OS - Autonomous AGI Core
After=network.target

[Service]
User=$USER
ExecStart=$HOME/.skyscope_os/env/bin/python3 $HOME/.skyscope_os/env/orchestrator.py
Restart=always
Environment=\"HOME=$HOME\"
WorkingDirectory=$HOME/.skyscope_os/env

[Install]
WantedBy=multi-user.target
EOF"

sudo systemctl daemon-reload
sudo systemctl enable skyscope.service
sudo systemctl start skyscope.service

success "SkyScope OS has been successfully installed and is now running."
info "To interact with the AGI, open a new terminal and type: skyscope"
info "The API endpoint is available at http://localhost:8000"
